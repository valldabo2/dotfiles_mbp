Inspiration
https://www.gnu.org/software/emacs/manual/html_node/emacs/Saving-Customizations.html
https://github.com/vidjuheffex/dotemacs/blob/master/emacs.org
https://jamiecollinson.com/blog/my-emacs-config/

* TODO
  https://github.com/alphapapa/org-rifle
* Config
  #+BEGIN_SRC emacs-lisp
    (defun reload-emacs-configuration ()
      (interactive)
      (load-file user-init-file))

    (defun open-emacs-configuration ()
      (interactive)
      (find-file "~/.emacs.d/emacs.org"))
  #+END_SRC
* Backups
  #+BEGIN_SRC emacs-lisp
    (setq backup-directory-alist '(("." . "~/.emacs.d/backups")))
  #+END_SRC
* General settings
   #+BEGIN_SRC emacs-lisp
     (global-display-line-numbers-mode)

     (dolist (hook '(text-mode-hook))
       (add-hook hook (lambda () (flyspell-mode 1))))

     (setq buffer-save-without-query t)
   #+END_SRC
* GUI
  #+BEGIN_SRC emacs-lisp
    (menu-bar-mode -1)
    (tool-bar-mode -1)
    (scroll-bar-mode -1)
  #+END_SRC
* Necessary
  Makes the custom variables not be inside init.el. But in a custom file created
  https://www.gnu.org/software/emacs/manual/html_node/emacs/Saving-Customizations.html
  #+BEGIN_SRC emacs-lisp
    (setq custom-file (make-temp-file "emacs-custom"))
  #+END_SRC

  Add support for more packages
  #+BEGIN_SRC emacs-lisp
    (require 'package)
    (setq package-archives
	  '(("gnu" . "https://elpa.gnu.org/packages/")
	    ("org" . "http://orgmode.org/elpa/")
	    ("melpa" . "https://melpa.org/packages/")))
    (package-initialize)
    (package-refresh-contents)
  #+END_SRC

  Use package for more compact package management
  #+BEGIN_SRC emacs-lisp
    (unless (package-installed-p 'use-package)
      (package-install 'use-package)
      (eval-when-compile (require 'use-package)))
    (setq use-package-always-ensure t)
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package exec-path-from-shell)
    (when (memq window-system '(mac ns x))
      (exec-path-from-shell-initialize))
  #+END_SRC

* Useful packages 
  #+BEGIN_SRC emacs-lisp
    (setq evil-want-integration t) 
    (setq evil-want-keybinding nil)

    (use-package evil 
      :config (evil-mode 1)
      )
    (use-package evil-collection
      :after evil
      :config
      (evil-collection-init)
      )

    (use-package evil-escape
      :config
      (setq-default evil-escape-key-sequence "fd")
      (evil-escape-mode)
      )
  #+END_SRC

  See which keys are available
  #+BEGIN_SRC emacs-lisp
    (use-package which-key :config (which-key-mode))
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package helm :config (helm-mode))
    (use-package helm-projectile)
    (use-package helm-rg)
    ;; (require 'helm-config)
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package powerline :config (powerline-default-theme))
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package dashboard 
      :config 
      (dashboard-setup-startup-hook)
      (add-hook 'dashboard-mode-hook 'normal-mode)
      )
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package projectile :config (projectile-mode +1))
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package magit)
    (use-package evil-magit)
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package ace-window
      :config
      ;; (ace-window-display-mode)
      )
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package evil-nerd-commenter)
  #+END_SRC
  
  #+BEGIN_SRC emacs-lisp
    (use-package ace-jump-mode)
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package company
      :config
      (add-hook 'after-init-hook 'global-company-mode)
      )
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package ace-link :config (ace-link-setup-default))
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package evil-matchit :config (global-evil-matchit-mode 1))
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package rainbow-delimiters)
    (add-hook 'prog-mode-hook #'rainbow-delimiters-mode)
  #+END_SRC

  #+BEGIN_SRC emacs-lisp
    (use-package winum :config (winum-mode))
  #+END_SRC
  
  https://melpa.org/#/yaml-mode
  #+BEGIN_SRC emacs-lisp
    (use-package yaml-mode)
    (add-to-list 'auto-mode-alist '("\\.yml\\'" . yaml-mode))
    (add-hook 'yaml-mode-hook
	      '(lambda ()
		 (define-key yaml-mode-map "\C-m" 'newline-and-indent)))
  #+END_SRC
* General Keybindings
  #+BEGIN_SRC emacs-lisp
    (use-package general)
    (general-auto-unbind-keys)

    (general-define-key
     :states '(normal visual emacs)
     :prefix "SPC"
 
     "m" '(:ignore t :which-key "Major")
 
     "TAB" '(evil-switch-to-windows-last-buffer :which-key "Last Buffer")
     "SPC" 'helm-M-x
     "a" '(:ignore t :which-key "Applications")
     "ad" 'dired
     "an" '(:ignore t :which-key "Notebook")
     "anr" 'ein:run
     "ans" 'ein:stop
     "ao" '(:ignore t :which-key "Org")
     "aoc" 'org-capture

     "f" '(:ignore t :which-key "Files")
     "fs" 'save-buffer
     "fr" 'helm-recentf
     "ff" 'helm-find-files
     "fS" 'save-some-buffers

     "d" '(:ignore t :which-key "Dotfile")
     "dr" 'reload-emacs-configuration
     "do" 'open-emacs-configuration

     "b" '(:ignore t :which-key "Buffers")
     "bb" 'helm-buffers-list
     "bd" 'kill-current-buffer

     "h" '(:ignore t :which-key "Help")
     "hk" 'describe-key 
     "hv" 'describe-variable
     "hm" 'describe-mode

     "j" '(:ignore t :which-key "Jump")
     "jw" 'ace-jump-word-mode 

     "s" '(:ignore t :which-key "Search")
     "ss" 'helm-occur 

     "l" '(:ignore t :which-key "Links")
     "lo" 'ace-link
     "ls" 'org-store-link

     "c" '(:ignore t :which-key "Comments")
     "cl" 'evilnc-comment-or-uncomment-lines

     "w" '(:ignore t :which-key "Windows")
     "wd" 'delete-window
     "wh" 'split-window-horizontally
     "wv" 'split-window-vertically
     "ws" 'ace-window
     "1" 'winum-select-window-1
     "2" 'winum-select-window-2
     "3" 'winum-select-window-3
     "4" 'winum-select-window-4
     "5" 'winum-select-window-5

     "p" '(:ignore: t :which-key "Projects")
     "pf" 'helm-projectile-find-file
     "pr" 'helm-projectile-recentf
     "pp" 'helm-projectile-switch-project

     "q" '(:ignore t :which-key "Quit")
     "qq" 'kill-emacs

     )
  #+END_SRC
* Tools
** Pdf 
   #+BEGIN_SRC emacs-lisp
     (use-package pdf-tools
       :config     
       (setq-default pdf-view-display-size 'fit-page)
       )
     (pdf-loader-install)
     (general-define-key
      :states 'normal
      :keymaps 'pdf-view-mode-map
      "," nil
      )
     (general-define-key
      :states '(normal override)
      :keymaps 'pdf-view-mode-map
      :prefix "SPC m"
      "f" 'pdf-view-fit-height-to-window
      "s" 'pdf-occur
      )
   #+END_SRC
** Org mode 
   #+BEGIN_SRC emacs-lisp
     (general-define-key
      :states 'normal
      :keymaps 'org-mode-map
      :prefix "SPC m"
      "c" 'org-capture
      "a" 'org-agenda
      "r" 'org-refile
      "l" '(:ignore t :which-key "Links")
      "li" 'org-insert-link
      "t" '(:ignore t :which-key "Toggle")
      "tl" 'org-latex-preview
      "j" '(:ignore t :which-key "Jump")
      "ji" 'helm-org-in-buffer-headings
      "'" 'org-edit-special
      )

     (setq org-capture-templates '(
				   ("t" "todo" entry
				    (file "~/Dropbox/org/gtd/inbox.org")
				    "* TODO %?
       %U
       %a
     " :clock-in t :clock-resume t)
				   ))

     (setq org-agenda-files '("~/Dropbox/org/gtd/inbox.org"
			      "~/Dropbox/org/gtd/gtd.org"
			      "~/Dropbox/org/gtd/someday.org"))

     (setq org-refile-targets '((nil :maxlevel . 9)
				(org-agenda-files :maxlevel . 9)
				("~/Dropbox/org/gtd/archive.org" :maxlevel . 1)))


     (setq org-agenda-custom-commands
	   '(("A" todo "DONE"))
	   )
   #+END_SRC
   #+BEGIN_SRC emacs-lisp
     (use-package evil-org
       :after org
       :config
       (add-hook 'org-mode-hook 'evil-org-mode)
       (add-hook 'evil-org-mode-hook
		 (lambda ()
		   (evil-org-set-key-theme)))
       (require 'evil-org-agenda)
       (evil-org-agenda-set-keys)
       )
   #+END_SRC
   #+BEGIN_SRC emacs-lisp
     ;; Makes org open pdf links correctly
     (add-to-list 'org-file-apps '("\\.pdf\\'" . (lambda (file link) (org-pdftools-open link))))

     (general-define-key 
      :states 'normal
      :keymaps'org-mode-map
      "RET" 'org-open-at-point)

     (use-package org-noter)
     (use-package org-pdftools)
     (org-pdftools-setup-link)

     (use-package org-noter-pdftools
       :after org-noter
       :config
       (with-eval-after-load 'pdf-annot
	 (add-hook 'pdf-annot-activate-handler-functions #'org-noter-pdftools-jump-to-note)))

     (use-package helm-org)
     (add-to-list 'helm-completing-read-handlers-alist '(org-capture . helm-org-completing-read-tags))
     (add-to-list 'helm-completing-read-handlers-alist '(org-set-tags . helm-org-completing-read-tags))
   #+END_SRC
** Markdown
   #+BEGIN_SRC emacs-lisp
     (use-package markdown-mode
       :ensure t
       :commands (markdown-mode gfm-mode)
       :mode (("README\\.md\\'" . gfm-mode)
	      ("\\.md\\'" . markdown-mode)
	      ("\\.markdown\\'" . markdown-mode))
       :init (setq markdown-command "multimarkdown"))
   #+END_SRC
* Programming
  https://www.flycheck.org/en/latest/
  #+BEGIN_SRC emacs-lisp
    (use-package flycheck :init (global-flycheck-mode))
  #+END_SRC
** Python
  #+BEGIN_SRC emacs-lisp
    (use-package pyenv-mode)
    (use-package importmagic
      :config
      (add-hook 'python-mode-hook 'importmagic-mode))
    (use-package python-pytest)
    (use-package quickrun)

    (use-package sphinx-doc)
    (add-hook 'python-mode-hook (lambda ()
				  (require 'sphinx-doc)
				  (sphinx-doc-mode t)))


    (general-define-key
     :states '(normal visual emacs)
     :keymaps 'python-mode-map
     :major-mode t
     :prefix "SPC m"
 
     "=" 'lsp-format-buffer
     "t" '(:ignore t :which-key "Tests")
     "tt" 'python-pytest
     "tf" 'python-pytest-function
     "t." 'python-pytest-popup
     "r" '(:ignore t :which-key "Run")
     "rr" 'quickrun
     "ra" 'quickrun-with-arg
     "d" '(:ignore: t :which-key "Debug")
     "db" 'dap-breakpoint-toggle
     "dd" 'dap-debug
     "i" '(run-python :which-key "ipython")
     "g" '(:ignore t :which-key "Go to")
     "gd" 'lsp-find-definition
     "gr" 'lsp-find-references
     )
  #+END_SRC
*** EIN 
   #+BEGIN_SRC emacs-lisp 
     (use-package ein)

     (general-define-key
      :definer 'minor-mode
      :states 'normal
      :keymaps 'ein:notebook-mode
      :prefix "SPC m"
      "b" 'ein:worksheet-insert-cell-below
      "a" 'ein:worksheet-insert-cell-above
      "s" 'ein:notebook-save-notebook-command
      "e" 'ein:worksheet-execute-cell
      "E" 'ein:worksheet-execute-all-cells
      "RET" 'ein:worksheet-execute-cell
      "d" 'ein:worksheet-delete-cell
      )
   #+END_SRC
** LSP
   https://emacs-lsp.github.io/lsp-mode/page/installation/
   #+BEGIN_SRC emacs-lisp
     (use-package lsp-mode
       :hook (
	      (python-mode . lsp)
	      (lsp-mode . lsp-enable-which-key-integration))
       :commands lsp)

     (use-package lsp-ui :commands lsp-ui-mode)
     (use-package helm-lsp :commands helm-lsp-workspace-symbol)
     (use-package lsp-treemacs :commands lsp-treemacs-errors-list)

     (use-package dap-mode)
     (require 'dap-python)

     (add-hook 'dap-stopped-hook
	       (lambda (arg) (call-interactively #'dap-hydra)))
   #+END_SRC
* Left over
  #+BEGIN_SRC emacs-lisp
    ;; Binds comma to SPC m for quicker major modes
    (general-evil-setup)
    (general-nmap "," (general-simulate-key "SPC m"))

    (add-hook 'fundamental-mode-hook 'normal-mode) 
    ;; Does not work
    ;; (add-hook 'messages-buffer-mode-hook 'normal-mode)
  #+END_SRC
